<?php  namespace app\index\controller;
use think\Controller;
use think\Db;
use think\Request;
use think\Session;
use think\View;
class Modals extends Base
{
	public function index()
	{
		if(check_login())
		{
			if(powerget())
			{
				$var_276=input('appletid');
				$var_6459=Db::table('applet')->where('id',$var_276)->find();
				if(!$var_6459)
				{
					$this->error('找不到对应的小程序！');
				}
				$this->assign('applet',$var_6459);
			}
			else
			{
				$var_6460=Session::get('usergroup');
				if($var_6460==1)
				{
					$this->error('您没有权限操作该小程序或找不到相应小程序！','Applet/applet');
				}
				if($var_6460==2)
				{
					$this->error('您没有权限操作该小程序或找不到相应小程序！','Applet/index');
				}
				if($var_6460==3)
				{
					$this->error('您没有权限操作该小程序或找不到相应小程序！','Applet/index');
				}
			}
			return $this->fetch(index);
		}
		else
		{
			$this->redirect('Login/index');
		}
	}
	public function add()
	{
		if(check_login())
		{
			if(powerget())
			{
				$var_6462=input('appletid');
				$var_6463=Db::table('applet')->where('id',$var_6462)->find();
				if(!$var_6463)
				{
					$this->error('找不到对应的小程序！');
				}
				$this->assign('applet',$var_6463);
				$var_6464=array();
				$var_6464=Db::table('ims_sudu8_page_cate')->where('uniacid',$var_6462)->select();
				$this->assign('cate',$var_6464);
				$var_6465=0;
				$v_2=array();
				$var_6466=input('cateid');
				$var_18=array();
				if($var_6466)
				{
					$var_6467=Db::table('ims_sudu8_page_cate')->where('id',$var_6466)->find();
					if($var_6467['catepic'])
					{
						$var_6467['catepic']=remote($var_6462,$var_6467['catepic'],1);
					}
					if($var_6467['onlyid'])
					{
						$var_18=Db::table('products_url')->where('randid',$var_6467['onlyid'])->select();
						foreach($var_18 as $var_6468=>&$var_6469)
						{
							$var_18[$var_6468]['url']=remote($var_6462,$var_6469['url'],1);
						}
					}
					else
					{
						$var_18=[];
					}
					if($var_6467['uniacid']==$var_6462)
					{
						$v_2=$var_6467;
						$v_2['cateconf']=unserialize($v_2['cateconf']);
						if($var_6467['cid']==0)
						{
							$var_6465=1;
						}
					}
					else
					{
						$var_6470=Session::get('usergroup');
						if($var_6470==1)
						{
							$this->error('找不到该栏目，或者该栏目不属于本小程序');
						}
						if($var_6470==2)
						{
							$this->error('找不到该栏目，或者该栏目不属于本小程序');
						}
					}
				}
				else
				{
					$var_6466=0;
				}
				$this->assign('allimg',$var_18);
				$this->assign('cateid',$var_6466);
				$this->assign('cateinfo',$v_2);
				$this->assign('cateurlid',$var_6465);
			}
			else
			{
				$var_6470=Session::get('usergroup');
				if($var_6470==1)
				{
					$this->error('您没有权限操作该小程序或找不到相应小程序！','Applet/applet');
				}
				if($var_6470==2)
				{
					$this->error('您没有权限操作该小程序或找不到相应小程序！','Applet/index');
				}
				if($var_6470==3)
				{
					$this->error('您没有权限操作该小程序或找不到相应小程序！','Applet/index');
				}
			}
			return $this->fetch(add);
		}
		else
		{
			$this->redirect('Login/index');
		}
	}
	public function save()
	{
		$var_6472=array();
		$var_6472['uniacid']=input('appletid');
		$var_6473=input('num');
		if($var_6473)
		{
			$var_6472['num']=$var_6473;
		}
		$var_6474=input('onlyid');
		$var_6475=input('imgsrcs/a');
		if($var_6475)
		{
			$var_6476=array();
			foreach($var_6475 as $var_6477=>$var_6478)
			{
				$var_6476['randid']=$var_6474;
				$var_6476['appletid']=$var_6472['uniacid'];
				$var_6476['url']=remote($var_6472['uniacid'],$var_6478,2);
				$var_6476['dateline']=time();
				$var_6479=Db::table('products_url')->insert($var_6476);
			}
		}
		else
		{
			$var_6479=1;
		}
		$var_6472['onlyid']=$var_6474;
		$var_6480=input('statue');
		if($var_6480===false)
		{
			$var_6472['statue']=1;
		}
		else
		{
			$var_6472['statue']=(int)$var_6480;
		}
		$var_6481=input('slide_is');
		if($var_6481)
		{
			$var_6472['slide_is']=(int)$var_6481;
		}
		else
		{
			$var_6472['slide_is']=2;
		}
		$var_2744=input('cid');
		if($var_2744)
		{
			$var_6472['cid']=$var_2744;
		}
		else
		{
			$var_6472['cid']=0;
		}
		$var_6482=input('name');
		if($var_6482)
		{
			$var_6472['name']=$var_6482;
		}
		else
		{
			$this->error('请填写栏目名称！');
		}
		$var_6483=input('ename');
		if($var_6483)
		{
			$var_6472['ename']=$var_6483;
		}
		$var_6484=Db::table('ims_sudu8_page_base')->where('uniacid',$var_6472['uniacid'])->field('remote')->find()['remote'];
		$var_6485=input('commonuploadpic');
		if($var_6485)
		{
			$var_6472['catepic']=remote($var_6472['uniacid'],$var_6485,2);
		}
		$var_6486=input('cdesc');
		if($var_6486)
		{
			$var_6472['cdesc']=$var_6486;
		}
		$var_6487=input('pagenum');
		if($var_6487)
		{
			$var_6472['pagenum']=$var_6487;
		}
		$var_6488=input('show_i');
		if($var_6488)
		{
			$var_6472['show_i']=$var_6488;
		}
		else
		{
			$var_6472['show_i']=0;
		}
		$var_6489=input('list_tstyle');
		if($var_6489)
		{
			$var_6472['list_tstyle']=$var_6489;
		}
		else
		{
			$var_6472['list_tstyle']=0;
		}
		$var_6490=input('list_tstylel');
		if($var_6490)
		{
			$var_6472['list_tstylel']=$var_6490;
		}
		else
		{
			$var_6472['list_tstylel']=0;
		}
		$var_6491=input('list_style_more');
		if($var_6491)
		{
			$var_6472['list_style_more']=input('list_style_more');
		}
		else
		{
			$var_6472['list_style_more']=1;
		}
		$var_6492=input('list_type');
		if($var_6492)
		{
			if($var_2744==0)
			{
				$var_6472['list_type']=$var_6492;
			}
			else
			{
				$var_6472['list_type']=1;
			}
		}
		else
		{
			if($var_2744==0)
			{
				$var_6472['list_type']=0;
			}
			else
			{
				$var_6472['list_type']=1;
			}
		}
		$var_363=input('list_style');
		if($var_363)
		{
			$var_6472['list_style']=$var_363;
		}
		$var_6493=input('list_stylet');
		if($var_6493)
		{
			$var_6472['list_stylet']=$var_6493;
		}
		$var_6494=input('pic_page_btn');
		if($var_6494)
		{
			$var_6472['pic_page_btn']=$var_6494;
		}
		else
		{
			$var_6472['pic_page_btn']=0;
		}
		$var_6495=input('pic_page_btn_zt');
		if($var_6495)
		{
			$var_6472['pic_page_btn_zt']=$var_6495;
		}
		else
		{
			$var_6472['pic_page_btn_zt']=0;
		}
		$var_6496=input('type');
		if($var_6496)
		{
			$var_6472['type']=$var_6496;
		}
		if($var_6496=='page')
		{
			$var_6472['list_style']=3;
		}
		$var_6497=input('pic_page_bg');
		if($var_6497!==false&& $var_6497!==null)
		{
			$var_6472['pic_page_bg']=$var_6497;
		}
		else
		{
			$var_6472['pic_page_bg']=0;
		}
		$var_6498=input('content');
		if($var_6498)
		{
			$var_6472['content']=$var_6498;
		}
		$var_6499=array('pmarb' =>input('pmarb'),'ptit' =>input('ptit'),);
		$var_6472['cateconf']=serialize($var_6499);
		$var_222=input('cateid');
		if($var_222!=0)
		{
			$var_6500=Db::table('ims_sudu8_page_cate')->where('id',$var_222)->update($var_6472);
			$var_6501=Db::table('ims_sudu8_page_products')->where('cid',$var_222)->select();
			foreach($var_6501 as $var_6477=>$var_6478)
			{
				if($var_6472['cid']==0)
				{
					Db::table('ims_sudu8_page_products')->where('cid',$var_222)->update(array('pcid'=>$var_222));
				}
				else
				{
					Db::table('ims_sudu8_page_products')->where('cid',$var_222)->update(array('pcid'=>$var_6472['cid']));
				}
			}
		}
		else
		{
			$var_6500=Db::table('ims_sudu8_page_cate')->insert($var_6472);
		}
		if($var_6500|| $var_6479)
		{
			$this->success('栏目信息更新成功！');
		}
		else
		{
			$this->error('基础信息更新失败，没有修改项！');
			exit;
		}
	}
	public function del()
	{
		$var_809['id']=input('cateid');
		$var_6503=Db::table('ims_sudu8_page_cate')->where($var_809)->delete();
		if($var_6503)
		{
			$this->success('删除成功');
		}
		else
		{
			$this->success('删除失败');
		}
	}
	function onepic_uploade($v_1)
	{
		$var_6505=request()->file($v_1);
		if(isset($var_6505))
		{
			$var_6506=upload_img();
			$var_6507=$var_6505->move($var_6506);
			if($var_6507)
			{
				$var_6508=ROOT_HOST.'/upimages/'.date('Ymd',time()).'/'.$var_6507->getFilename();
				return $var_6508;
			}
		}
	}
	public function imgupload()
	{
		$var_6509['randid']=$_GET['randid'];
		$var_6510=request()->file('');
		foreach($var_6510 as $var_6511)
		{
			$var_6512=$var_6511->validate(['ext'=>'jpg,png,gif,jpeg'])->move(ROOT_PATH.'public' .DS.'upimages');
			if($var_6512)
			{
				$var_6509['url']=ROOT_HOST.'/upimages/'.date('Ymd',time()).'/'.$var_6512->getFilename();
				$var_6509['dateline']=time();
				$var_267=Db::table('products_url')->insert($var_6509);
			}
			else
			{
				return $this->error($var_6511->getError());
			}
		}
	}
	public function getimg()
	{
		$var_6514=$_POST['id'];
		$var_6515=Db::table('products_url')->where('randid',$var_6514)->select();
		if($var_6515)
		{
			return $var_6515;
		}
	}
}
?>