<?php  namespace app\index\controller;
use think\Controller;
use think\Db;
use think\Request;
use think\Session;
use think\View;
class Shake extends Base
{
	public function index()
	{
		if(check_login())
		{
			if(powerget())
			{
				$var_7353=input('appletid');
				$var_7354=Db::name('applet')->where('id',$var_7353)->find();
				$this->assign('applet',$var_7354);
				$var_391=Db::table('ims_sudu8_page_lottery_activity')->where('uniacid',$var_7353)->order('id desc')->paginate(10);
				$var_7355=Db::table('ims_sudu8_page_lottery_activity')->where('uniacid',$var_7353)->count();
				$this->assign('activity',$var_391);
				$this->assign(count,$var_7355);
				return $this->fetch(index);
			}
			else
			{
				$var_485=Session::get('usergroup');
				if($var_485==1)
				{
					$this->error('您没有权限操作该小程序或找不到相应小程序！','Applet/applet');
				}
				if($var_485==2)
				{
					$this->error('您没有权限操作该小程序或找不到相应小程序！','Applet/index');
				}
				if($var_485==3)
				{
					$this->error('您没有权限操作该小程序或找不到相应小程序！','Applet/index');
				}
			}
		}
		else
		{
			$this->redirect('Login/index');
		}
	}
	public function add()
	{
		if(powerget())
		{
			$var_7357=input('appletid');
			$var_7358=Db::name('applet')->where('id',$var_7357)->find();
			$this->assign('applet',$var_7358);
			return $this->fetch(add);
		}
		else
		{
			$var_7359=Session::get('usergroup');
			if($var_7359==1)
			{
				$this->error('您没有权限操作该小程序或找不到相应小程序！','Applet/applet');
			}
			if($var_7359==2)
			{
				$this->error('您没有权限操作该小程序或找不到相应小程序！','Applet/index');
			}
			if($var_7359==3)
			{
				$this->error('您没有权限操作该小程序或找不到相应小程序！','Applet/index');
			}
		}
	}
	public function setsave()
	{
		$var_7361=input('appletid');
		$var_7362['uniacid']=$var_7361;
		$var_7363=input('title');
		if($var_7363)
		{
			$var_7362['title']=$var_7363;
		}
		else
		{
			$this->error('请输入活动名称');
		}
		$var_7364=input('begin');
		if($var_7364)
		{
			$var_7365=date_parse_from_format('Y年m月d日 H:i:s',$var_7364);
			$var_7366=mktime($var_7365['hour'],$var_7365['minute'],$var_7365['second'],$var_7365['month'],$var_7365['day'],$var_7365['year']);
			$var_7362['begin']=$var_7366;
		}
		else
		{
			$this->error('请输入活动开始时间');
		}
		$var_7367=input(end);
		if($var_7367)
		{
			$var_7365=date_parse_from_format('Y年m月d日 H:i:s',$var_7367);
			$var_7366=mktime($var_7365['hour'],$var_7365['minute'],$var_7365['second'],$var_7365['month'],$var_7365['day'],$var_7365['year']);
			$var_7362[end]=$var_7366;
		}
		else
		{
			$this->error('请输入活动结束时间');
		}
		$var_7368=input('descp');
		if($var_7368)
		{
			$var_7362['descp']=$var_7368;
		}
		else
		{
			$this->error('请输入活动规则');
		}
		$var_7369=input('commonuploadpic1');
		if($var_7369)
		{
			$var_7362['thumb']=$var_7369;
		}
		else
		{
			$this->error('请选择活动缩略图');
		}
		$var_7370=input('commonuploadpic2');
		if($var_7370)
		{
			$var_7362['bg']=$var_7370;
		}
		else
		{
			$this->error('请选择背景图');
		}
		$var_240=input('commonuploadpic3');
		if($var_240)
		{
			$var_7362['text_img1']=$var_240;
		}
		else
		{
			$this->error('请选择点击模式标题图');
		}
		$var_733=input('commonuploadpic4');
		if($var_733)
		{
			$var_7362['text_img2']=$var_733;
		}
		else
		{
			$this->error('请选择摇一摇模式标题图');
		}
		$var_7362['nav_color']='#'.input('nav_color');
		$var_7362['status']=input('status');
		$var_7362['createtime']=time();
		$var_7371['means']=input('means');
		if(input('jifen'))
		{
			$var_7371['jifen']=input('jifen');
		}
		else
		{
			$var_7371['jifen']=10;
		}
		if(input('every_join'))
		{
			$var_7371['every_join']=input('every_join');
		}
		else
		{
			$var_7371['every_join']=3;
		}
		if(input('just_one'))
		{
			$var_7371['just_one']=input('just_one');
		}
		else
		{
			$var_7371['just_one']=0;
		}
		if(input('users_type'))
		{
			$var_7371['users_type']=input('users_type');
		}
		else
		{
			$var_7371['users_type']=0;
		}
		if(input('fill_time'))
		{
			$var_7371['fill_time']=input('fill_time');
		}
		else
		{
			$var_7371['fill_time']=0;
		}
		if(input('share_add'))
		{
			$var_7371['share_add']=input('share_add');
		}
		else
		{
			$var_7371['share_add']=1;
		}
		if(input('everyday_share'))
		{
			$var_7371['everyday_share']=input('everyday_share');
		}
		else
		{
			$var_7371['everyday_share']=1;
		}
		if(input('total_share'))
		{
			$var_7371['total_share']=input('total_share');
		}
		else
		{
			$var_7371['total_share']=1;
		}
		$var_7362['base']=serialize($var_7371);
		$var_7372=Db::table('ims_sudu8_page_lottery_activity')->insert($var_7362);
		if($var_7372)
		{
			$this->success('活动创建成功!',Url('shake/index').'?appletid='.$var_7361);
		}
		else
		{
			$this->error('发生网络错误,活动创建失败!');
		}
	}
	public function edit()
	{
		if(powerget())
		{
			$var_7373=input('aid');
			$var_7374=input('appletid');
			$var_7375=Db::name('applet')->where('id',$var_7374)->find();
			$this->assign('applet',$var_7375);
			$var_7376=Db::table('ims_sudu8_page_lottery_activity')->where('id',$var_7373)->find();
			$var_930=unserialize($var_7376['base']);
			$this->assign('activity',$var_7376);
			$this->assign('base',$var_930);
			return $this->fetch(edit);
		}
		else
		{
			$var_7377=Session::get('usergroup');
			if($var_7377==1)
			{
				$this->error('您没有权限操作该小程序或找不到相应小程序！','Applet/applet');
			}
			if($var_7377==2)
			{
				$this->error('您没有权限操作该小程序或找不到相应小程序！','Applet/index');
			}
			if($var_7377==3)
			{
				$this->error('您没有权限操作该小程序或找不到相应小程序！','Applet/index');
			}
		}
	}
	public function setedit()
	{
		$var_7379=input('appletid');
		$v_2=input('aid');
		$var_7380['uniacid']=$var_7379;
		$var_7381=input('title');
		if($var_7381)
		{
			$var_7380['title']=$var_7381;
		}
		else
		{
			$this->error('请输入活动名称');
		}
		$var_364=input('begin');
		if($var_364)
		{
			$var_113=date_parse_from_format('Y年m月d日 H:i:s',$var_364);
			$var_7382=mktime($var_113['hour'],$var_113['minute'],$var_113['second'],$var_113['month'],$var_113['day'],$var_113['year']);
			$var_7380['begin']=$var_7382;
		}
		else
		{
			$this->error('请输入活动开始时间');
		}
		$var_7383=input(end);
		if($var_7383)
		{
			$var_113=date_parse_from_format('Y年m月d日 H:i:s',$var_7383);
			$var_7382=mktime($var_113['hour'],$var_113['minute'],$var_113['second'],$var_113['month'],$var_113['day'],$var_113['year']);
			$var_7380[end]=$var_7382;
		}
		else
		{
			$this->error('请输入活动结束时间');
		}
		$var_7384=input('descp');
		if($var_7384)
		{
			$var_7380['descp']=$var_7384;
		}
		else
		{
			$this->error('请输入活动规则');
		}
		$var_7385=input('commonuploadpic1');
		if($var_7385)
		{
			$var_7380['thumb']=$var_7385;
		}
		else
		{
			$this->error('请选择活动缩略图');
		}
		$var_7386=input('commonuploadpic2');
		if($var_7386)
		{
			$var_7380['bg']=$var_7386;
		}
		else
		{
			$this->error('请选择背景图');
		}
		$var_7387=input('commonuploadpic3');
		if($var_7387)
		{
			$var_7380['text_img1']=$var_7387;
		}
		else
		{
			$this->error('请选择点击模式标题图');
		}
		$var_7388=input('commonuploadpic4');
		if($var_7388)
		{
			$var_7380['text_img2']=$var_7388;
		}
		else
		{
			$this->error('请选择摇一摇模式标题图');
		}
		$var_7380['nav_color']='#'.input('nav_color');
		$var_7380['status']=input('status');
		$var_7389['means']=input('means');
		$var_7390=input('jifen');
		if(isset($var_7390))
		{
			$var_7389['jifen']=$var_7390;
		}
		else
		{
			$var_7389['jifen']=10;
		}
		if(input('every_join'))
		{
			$var_7389['every_join']=input('every_join');
		}
		else
		{
			$var_7389['every_join']=3;
		}
		if(input('just_one'))
		{
			$var_7389['just_one']=input('just_one');
		}
		else
		{
			$var_7389['just_one']=0;
		}
		if(input('users_type'))
		{
			$var_7389['users_type']=input('users_type');
		}
		else
		{
			$var_7389['users_type']=0;
		}
		if(input('fill_time'))
		{
			$var_7389['fill_time']=input('fill_time');
		}
		else
		{
			$var_7389['fill_time']=0;
		}
		if(input('share_add'))
		{
			$var_7389['share_add']=input('share_add');
		}
		else
		{
			$var_7389['share_add']=1;
		}
		if(input('everyday_share'))
		{
			$var_7389['everyday_share']=input('everyday_share');
		}
		else
		{
			$var_7389['everyday_share']=1;
		}
		if(input('total_share'))
		{
			$var_7389['total_share']=input('total_share');
		}
		else
		{
			$var_7389['total_share']=1;
		}
		$var_7380['base']=serialize($var_7389);
		$var_363=Db::table('ims_sudu8_page_lottery_activity')->where('id',$v_2)->update($var_7380);
		if($var_363!==false)
		{
			$this->success('活动编辑成功!',Url('shake/index').'?appletid='.$var_7379);
		}
		else
		{
			$this->error('发生网络错误,活动编辑失败!');
		}
	}
	public function delActivity()
	{
		$var_167=input('id');
		$var_370=input('appletid');
		$var_7392=Db::table('ims_sudu8_page_lottery_activity')->where('uniacid',$var_370)->where('id',$var_167)->delete();
		if($var_7392)
		{
			return 1;
		}
		else
		{
			return 2;
		}
	}
	public function setprize()
	{
		if(powerget())
		{
			$var_7394=input('aid');
			$var_7395=input('appletid');
			$var_7396=Db::name('applet')->where('id',$var_7395)->find();
			$this->assign('applet',$var_7396);
			$var_7397=Db::table('ims_sudu8_page_lottery_activity')->where('id',$var_7394)->find();
			$var_715=unserialize($var_7397['base']);
			$this->assign('activity',$var_7397);
			$this->assign('base',$var_715);
			$var_7398=Db::table('ims_sudu8_page_coupon')->where('uniacid',$var_7395)->select();
			$this->assign('coupons',$var_7398);
			$v_7=Db::table('ims_sudu8_page_lottery_prize')->where('uniacid',$var_7395)->where('aid',$var_7394)->select();
			foreach($v_7 as $var_126=>&$var_7399)
			{
				if($var_7399['types']==4)
				{
					$var_7400=Db::table('ims_sudu8_page_coupon')->where('id',$var_7399['detail'])->find();
					$var_7399['detail']=$var_7400['title'];
				}
			}
			$this->assign('prizes',$v_7);
			$var_7401=array();
			$var_7402=array();
			$var_7403=0;
			$var_7404=0;
			for($var_7405=1;$var_7405<=8;$var_7405++)
			{
				$var_7401[$var_7405]=Db::table('ims_sudu8_page_lottery_prize')->where('uniacid',$var_7395)->where('aid',$var_7394)->where('num','like',"%$var_7405%")->find();
				$var_7406=true;
				if(!empty($var_7401[$var_7405]))
				{
					if(!empty($var_7402))
					{
						foreach($var_7402 as $var_5519)
						{
							if($var_5519['id']==$var_7401[$var_7405]['id'])
							{
								$var_7406=false;
							}
						}
					}
					if($var_7406)
					{
						$var_7402[]=$var_7401[$var_7405];
					}
				}
			}
			foreach($var_7402 as $var_7407=>&$var_7408)
			{
				$var_7409=count(explode('|',$var_7408['num']));
				$var_7408['total_num']=$var_7408['total']*$var_7409;
				$var_7408['total_chance']=$var_7408['chance']*$var_7409/100;
				if($var_7408['types']==4)
				{
					$var_809=Db::table('ims_sudu8_page_coupon')->where('uniacid',$var_7395)->where('id',$var_7408['detail'])->field('title')->find();
					$var_7408['detail']=$var_809['title'];
				}
				if($var_7408['types']==1)
				{
					$var_7408['detail'].= '积分';
				}
				if($var_7408['types']==2)
				{
					$var_7408['detail'].= '元';
				}
				$var_7403+= $var_7408['total_num'];
				$var_7404+= $var_7408['total_chance'];
			}
			$this->assign('selectedPrizes',$var_7401);
			$this->assign('prizes_set',$var_7402);
			$this->assign('total_num_sum',$var_7403);
			$this->assign('total_chance_sum',$var_7404);
			return $this->fetch(setprize);
		}
		else
		{
			$var_7410=Session::get('usergroup');
			if($var_7410==1)
			{
				$this->error('您没有权限操作该小程序或找不到相应小程序！','Applet/applet');
			}
			if($var_7410==2)
			{
				$this->error('您没有权限操作该小程序或找不到相应小程序！','Applet/index');
			}
			if($var_7410==3)
			{
				$this->error('您没有权限操作该小程序或找不到相应小程序！','Applet/index');
			}
		}
	}
	public function changeMeans()
	{
		$var_7412=input('id');
		$var_7413=Db::table('ims_sudu8_page_lottery_activity')->where('id',$var_7412)->find();
		$var_7414=unserialize($var_7413['base']);
		if($var_7414['means']==1)
		{
			$var_7414['means']=0;
		}
		else
		{
			$var_7414['means']=1;
		}
		$var_68['base']=serialize($var_7414);
		$var_7415=Db::table('ims_sudu8_page_lottery_activity')->where('id',$var_7412)->update($var_68);
		if($var_7415)
		{
			return $var_7414['means'];
		}
	}
	public function addPrize()
	{
		if(powerget())
		{
			$var_7417=input('appletid');
			$var_7418=input('pid');
			$var_7419=array('title' =>input('title'),'thumb' =>input('thumb'),'types' =>input('types'),'total' =>input('total'),'detail' =>input('detail'),'chance' =>input('chance'),);
			if(!empty($var_7418))
			{
				$var_7420=Db::table('ims_sudu8_page_lottery_prize')->where('uniacid',$var_7417)->where('id',$var_7418)->find();
				$var_7419['storage']=intval(input('total'))-intval($var_7420['total'])+intval($var_7420['storage']);
				if($var_7419['storage']<0)$var_7419['storage']=0;
				Db::table('ims_sudu8_page_lottery_prize')->where('uniacid',$var_7417)->where('id',$var_7418)->update($var_7419);
				$var_7419['id']=$var_7418;
				$var_7419['flag']='modify';
			}
			else
			{
				$var_7419['uniacid']=$var_7417;
				$var_7419['aid']=input('aid');
				$var_7419['createtime']=time();
				$var_7419['storage']=$var_7419['total'];
				$var_7419['num']='';
				Db::table('ims_sudu8_page_lottery_prize')->insert($var_7419);
				$var_7419['id']=Db::table('ims_sudu8_page_lottery_prize')->getLastInsID();
				$var_7419['flag']=add;
			}
			if(strpos($var_7419['thumb'],'http')===false)
			{
				$var_7419['thumb']=$var_7419['thumb'];
			}
			if($var_7419['types']==4)
			{
				$var_2966=Db::name('ims_sudu8_page_coupon')->where('uniacid',$var_7417)->where('id',$var_7419['detail'])->field('title')->find();
				$var_7419['detail']=$var_2966['title'];
			}
			if($var_7419['types']==1)
			{
				$var_7419['detail'].= '积分';
			}
			if($var_7419['types']==2)
			{
				$var_7419['detail'].= '余额';
			}
			$var_7419['chance']/= 100;
			return json_encode($var_7419,JSON_UNESCAPED_UNICODE);
		}
		else
		{
			$var_1304=Session::get('usergroup');
			if($var_1304==1)
			{
				$this->error('您没有权限操作该小程序或找不到相应小程序！','Applet/applet');
			}
			if($var_1304==2)
			{
				$this->error('您没有权限操作该小程序或找不到相应小程序！','Applet/index');
			}
			if($var_1304==3)
			{
				$this->error('您没有权限操作该小程序或找不到相应小程序！','Applet/index');
			}
		}
	}
	public function selectPrize()
	{
		if(powerget())
		{
			$var_7422=input('appletid');
			$var_7423=input('id');
			$var_408=input('aid');
			$var_7424=input('num');
			$var_629=Db::table('ims_sudu8_page_lottery_prize')->where('uniacid',$var_7422)->where('aid',$var_408)->where('num','like',"%$var_7424%")->find();
			if(empty($var_629)|| $var_629['id']!=$var_7423)
			{
				$var_7425=0;
				for($var_7426=1;$var_7426<=8;$var_7426++)
				{
					if($var_7426!=$var_7424)
					{
						$var_7427=Db::table('ims_sudu8_page_lottery_prize')->where('uniacid',$var_7422)->where('aid',$var_408)->where('num','like',"%$var_7426%")->find();
						$var_7425+= $var_7427['chance'];
					}
				}
				$var_7428=Db::table('ims_sudu8_page_lottery_prize')->where('uniacid',$var_7422)->where('aid',$var_408)-> where('id',$var_7423)->field('chance')->find();
				$var_7428=$var_7428['chance'];
				if($var_7425+$var_7428>=10000)
				{
					$var_7429=array('flag'=>1,'warning' =>'添加失败，总概率必须小于100%');
					return json_encode($var_7429,JSON_UNESCAPED_UNICODE);
				}
			}
			$var_7430=Db::table('ims_sudu8_page_lottery_activity')->where('uniacid',$var_7422)->where('id',$var_408)->field('base')->find();
			$var_7430=unserialize($var_7430['base']);
			if($var_7430['just_one']==1 && empty($var_629))
			{
				$var_7431=false;
				for($var_7426=1;$var_7426<=8;$var_7426++)
				{
					if($var_7426!=$var_7424)
					{
						$var_7432=Db::table('ims_sudu8_page_lottery_prize')->where('uniacid',$var_7422)->where('aid',$var_408)->where('num','like',"%$var_7426%")->find();
						if(empty($var_7432))
						{
							$var_7431=true;
						}
					}
				}
				if(!$var_7431)
				{
					$var_7429=array('flag'=>2,'warning' =>'因每人只能中一次奖，8格不能全设');
					return json_encode($var_7429,JSON_UNESCAPED_UNICODE);
				}
			}
			if(!empty($var_629)&& $var_629['id']!=$var_7423)
			{
				$var_7433=explode('|',$var_629['num']);
				foreach($var_7433 as $var_7434=>$var_7435)
				{
					if($var_7435==$var_7424)
					{
						unset($var_7433[$var_7434]);
					}
				}
				$var_7433=implode('|',$var_7433);
				$var_7436=array('num' =>$var_7433);
				Db::table('ims_sudu8_page_lottery_prize')->where('uniacid',$var_7422)->where('aid',$var_408)->where('id',$var_629['id'])->update($var_7436);
			}
			if($var_629['id']!=$var_7423)
			{
				$var_78=Db::table('ims_sudu8_page_lottery_prize')->where('uniacid',$var_7422)->where('aid',$var_408)->where('id',$var_7423)->find();
				if(!empty($var_78['num']))
				{
					$var_78['num'].= '|' .$var_7424;
				}
				else
				{
					$var_78['num']=$var_7424;
				}
				$var_198=array('num' =>$var_78['num']);
				Db::table('ims_sudu8_page_lottery_prize')->where('uniacid',$var_7422)->where('aid',$var_408)->where('id',$var_7423)->update($var_198);
			}
			$var_7437=Db::table('ims_sudu8_page_lottery_prize')->where('uniacid',$var_7422)->where('aid',$var_408)->where('id',$var_7423)->find();
			$var_7437['thumb_https']=$var_7437['thumb'];
			return json_encode($var_7437,JSON_UNESCAPED_UNICODE);
		}
		else
		{
			$var_7438=Session::get('usergroup');
			if($var_7438==1)
			{
				$this->error('您没有权限操作该小程序或找不到相应小程序！','Applet/applet');
			}
			if($var_7438==2)
			{
				$this->error('您没有权限操作该小程序或找不到相应小程序！','Applet/index');
			}
			if($var_7438==3)
			{
				$this->error('您没有权限操作该小程序或找不到相应小程序！','Applet/index');
			}
		}
	}
	public function deletePrize()
	{
		if(powerget())
		{
			$var_267=input('appletid');
			$var_7439=input('id');
			$var_7440=input(index);
			$var_613=Db::table('ims_sudu8_page_lottery_prize')->where('uniacid',$var_267)->where('aid',$var_7439)->where('num','like',"%$var_7440%")->find();
			if(!empty($var_613))
			{
				$var_7441=explode('|',$var_613['num']);
				foreach($var_7441 as $var_7065=>$var_7442)
				{
					if($var_7442==$var_7440)
					{
						unset($var_7441[$var_7065]);
					}
				}
				$var_7441=implode('|',$var_7441);
				$var_7443=array('num' =>$var_7441);
				Db::table('ims_sudu8_page_lottery_prize')->where('uniacid',$var_267)->where('aid',$var_7439)->where('id',$var_613['id'])->update($var_7443);
			}
		}
		else
		{
			$var_7444=Session::get('usergroup');
			if($var_7444==1)
			{
				$this->error('您没有权限操作该小程序或找不到相应小程序！','Applet/applet');
			}
			if($var_7444==2)
			{
				$this->error('您没有权限操作该小程序或找不到相应小程序！','Applet/index');
			}
			if($var_7444==3)
			{
				$this->error('您没有权限操作该小程序或找不到相应小程序！','Applet/index');
			}
		}
	}
	public function getPrize()
	{
		$var_7446=input('id');
		$var_7447=Db::table('ims_sudu8_page_lottery_prize')->where('id',$var_7446)->find();
		return json_encode($var_7447);
	}
	public function delPrize()
	{
		$var_7449=input('id');
		$var_7450=input('appletid');
		$var_7451=Db::table('ims_sudu8_page_lottery_prize')->where('id',$var_7449)->where('uniacid',$var_7450)->delete();
		return json_encode($var_7451);
	}
	public function record()
	{
		if(powerget())
		{
			$var_7452=input('appletid');
			$var_7453=Db::name('applet')->where('id',$var_7452)->find();
			$this->assign('applet',$var_7453);
			$var_7454=input('aid');
			$var_7455=array();
			for($var_7456=1;$var_7456<=8;$var_7456++)
			{
				$var_341=Db::table('ims_sudu8_page_lottery_prize')->where('uniacid',$var_7452)->where('aid',$var_7454)->where('num','like',"%$var_7456%")->find();
				if(!empty($var_341)&& !in_array($var_341,$var_7455))
				{
					$var_7455[]=$var_341;
				}
			}
			foreach($var_7455 as $var_7457=>&$var_868)
			{
				if($var_868['types']==1)
				{
					$var_868['detail']='积分：' .$var_868['detail'].'积分';
				}
				if($var_868['types']==2)
				{
					$var_868['detail']='余额：' .$var_868['detail'].'元';
				}
				if($var_868['types']==3)
				{
					$var_868['detail']='实物：' .$var_868['detail'];
				}
				if($var_868['types']==4)
				{
					$var_59=Db::table('ims_sudu8_page_coupon')->where('uniacid',$var_7452)->where('id',$var_868['detail'])->field('title')->find();
					$var_868['detail']='优惠券：' .$var_59['title'];
				}
			}
			$var_7458='';
			$var_276='';
			$var_486='';
			if(!empty(input('select_pid'))|| in_array(input('select_status'),[0,1,2]))
			{
				if(!empty(input('select_pid')))
				{
					$var_276=input('select_pid');
					$var_7458.= ' pid = '.$var_276;
					if(in_array(input('select_status'),[0,1,2]))
					{
						$var_486=input('select_status');
						$var_7458.= ' and status = '.$var_486;
					}
				}
				else
				{
					if(in_array(input('select_status'),[0,1,2]))
					{
						$var_486=input('select_status');
						$var_7458.= ' status = '.$var_486;
					}
				}
			}
			$this->assign('select_pid',$var_276);
			$this->assign('select_status',$var_486);
			$var_7459=Db::table('ims_sudu8_page_lottery_record')->where('uniacid',$var_7452)->where('aid',$var_7454)->where($var_7458)->count();
			$var_7460=Db::table('ims_sudu8_page_lottery_record')->where('uniacid',$var_7452)->where('aid',$var_7454)->where($var_7458)->order('createtime desc')->paginate(10,false,['query' =>array('appletid'=>input('appletid'),'aid'=>input('aid'))]);
			$var_7461=Db::table('ims_sudu8_page_lottery_record')->where('uniacid',$var_7452)->where('aid',$var_7454)->where($var_7458)->order('createtime desc')->select();
			$var_7462=$var_7460->render();
			$var_7463=$var_7460->toArray();
			Session::set('excel_records',$var_7461);
			foreach($var_7463['data'] as $var_7464=>&$var_7465)
			{
				$var_106=Db::table('ims_sudu8_page_user')->where('uniacid',$var_7452)->where('id',$var_7465['uid'])->find();
				$var_7465['realname']=$var_106['realname']?$var_106['realname']:'暂无';
				$var_7465['mobile']=$var_106['mobile']?$var_106['mobile']:'暂无';
				$var_7465['address']=$var_106['address']?$var_106['address']:'暂无';
				$var_7465['createtime']=date('Y-m-d H:i:s',$var_7465['createtime']);
				if($var_7465['status']!=0)
				{
					$var_102=Db::table('ims_sudu8_page_lottery_prize')->where('uniacid',$var_7452)->where('id',$var_7465['pid'])->find();
					$var_7465['types']=$var_102['types'];
					if($var_102['types']==1)
					{
						$var_7465['prize_detail']=$var_102['detail'].'积分';
					}
					else if($var_102['types']==2)
					{
						$var_7465['prize_detail']=$var_102['detail'].'元';
					}
					else if($var_102['types']==4)
					{
						$var_59=Db::table('ims_sudu8_page_coupon')->where('uniacid',$var_7452)->where('id',$var_102['detail'])->field('title')->find();
						$var_7465['prize_detail']=$var_59['title'];
					}
					else
					{
						$var_7465['prize_detail']=$var_102['detail'];
					}
				}
			}
			$this->assign('prizesSet',$var_7455);
			$this->assign('records',$var_7463);
			$this->assign('page',$var_7462);
			return $this->fetch(record);
		}
		else
		{
			$var_7466=Session::get('usergroup');
			if($var_7466==1)
			{
				$this->error('您没有权限操作该小程序或找不到相应小程序！','Applet/applet');
			}
			if($var_7466==2)
			{
				$this->error('您没有权限操作该小程序或找不到相应小程序！','Applet/index');
			}
			if($var_7466==3)
			{
				$this->error('您没有权限操作该小程序或找不到相应小程序！','Applet/index');
			}
		}
	}
	public function toExcel()
	{
		$var_7467=input('aid');
		$var_7468=input('appletid');
		$var_7469=Session::get('excel_records');
		require_once ROOT_PATH.'public/plugin/PHPExcel/PHPExcel.php';
		$var_7470=new \PHPExcel();
		$var_7470->getProperties()->setCreator('导出抽奖记录')->setLastModifiedBy('抽奖记录')->setTitle('导出抽奖记录')->setSubject('导出抽奖记录')->setDescription('导出抽奖记录')->setKeywords('导出抽奖记录')->setCategory('导出抽奖记录');
		$var_7470->getActiveSheet()->setCellValue('A1','抽奖人姓名');
		$var_7470->getActiveSheet()->setCellValue('B1','手机号');
		$var_7470->getActiveSheet()->setCellValue('C1','地址');
		$var_7470->getActiveSheet()->setCellValue('D1','中奖状态');
		$var_7470->getActiveSheet()->setCellValue('E1','中奖奖品');
		$var_7470->getActiveSheet()->setCellValue('F1','抽奖时间');
		foreach($var_7469 as $var_7471=>$var_7472)
		{
			$var_7473=$var_7471+2;
			$var_7474=Db::table('ims_sudu8_page_user')->where('uniacid',$var_7468)->where('id',$var_7472['uid'])->find();
			switch($var_7472['status'])
			{
				case 0:$var_7475='未中奖';
				break;
				case 1:$var_7475='待领取';
				break;
				case 2:$var_7475='已领取';
				break;
			}
			$var_7476='';
			if($var_7472['status']!=0)
			{
				$var_7477=Db::table('ims_sudu8_page_lottery_prize')->where('uniacid',$var_7468)->where('id',$var_7472['pid'])->find();
				if($var_7477['types']==1)
				{
					$var_7476=$var_7477['detail'].'积分';
				}
				else if($var_7477['types']==2)
				{
					$var_7476=$var_7477['detail'].'元';
				}
				else if($var_7477['types']==4)
				{
					$var_7478=Db::table('ims_sudu8_page_coupon')->where('uniacid',$var_7468)->where('id',$var_7477['detail'])->field('title')->find();
					$var_7476=$var_7478['title'];
				}
				else
				{
					$var_7476=$var_7477['detail'];
				}
			}
			$var_7470->getActiveSheet()->setCellValue('A'.$var_7473,$var_7474['realname'],'s');
			$var_7470->getActiveSheet()->setCellValue('B'.$var_7473,$var_7474['mobile'],'s');
			$var_7470->getActiveSheet()->setCellValue('C'.$var_7473,$var_7474['address'],'s');
			$var_7470->getActiveSheet()->setCellValue('D'.$var_7473,$var_7475,'s');
			$var_7470->getActiveSheet()->setCellValue('E'.$var_7473,$var_7476,'s');
			$var_7470->getActiveSheet()->setCellValue('F'.$var_7473,date('Y-m-d H:i:s',$var_7472['createtime']),'s');
		}
		$var_7470->getActiveSheet()->setTitle('导出抽奖信息');
		$var_7470->setActiveSheetIndex(0);
		header('Content-Type: application/vnd.ms-excel');
		header('Content-Disposition: attachment;filename="抽奖信息导出表.xls"');
		header('Cache-Control: max-age=0');
		$var_471=\PHPExcel_IOFactory::createWriter($var_7470,'Excel5');
		$var_471->save('php://output');
	}
	public function shenhe()
	{
		$var_7480=input('appletid');
		$var_7481=input('rid');
		$var_7482=array('status' =>2);
		$var_7483=Db::table('ims_sudu8_page_lottery_record')->where('uniacid',$var_7480)->where('id',$var_7481)->update($var_7482);
		if($var_7483)
		{
			return 1;
		}
		else
		{
			return 2;
		}
	}
	public function jfrule()
	{
		if(powerget())
		{
			$var_329=input('appletid');
			$var_7485=Db::name('applet')->where('id',$var_329)->find();
			$this->assign('applet',$var_7485);
			$var_7486=Db::table('ims_sudu8_page_score_get')->where('uniacid',$var_329)->select();
			if(!$var_7486)
			{
				$var_7487[]=['title' =>'签到获取积分','descp' =>'点击进入签到页面，每日签到都可增加积分，快去试试吧！','score' =>10,link =>'/sudu8_page_plugin_sign/index/index','flag' =>1,'fixed' =>1,'uniacid' =>$var_329,];
				$var_7487[]=['title' =>'充值送积分','descp' =>'充值不仅送积分，还会送余额和优惠券哦！','score' =>10,link =>'/sudu8_page/recharge/recharge','flag' =>1,'fixed' =>2,'uniacid' =>$var_329,];
				$var_7487[]=['title' =>'分享文章送积分','descp' =>'分享文章页面给好友，马上可增加积分，好友点击还会获得更多积分，快去转发吧！','score' =>10,link =>'','flag' =>1,'fixed' =>3,'uniacid' =>$var_329,];
				$var_7487[]=['title' =>'购买送积分','descp' =>'购买商品后可以获得一定比例的积分！','score' =>10,link =>'','flag' =>1,'fixed' =>4,'uniacid' =>$var_329,];
				Db::table('ims_sudu8_page_score_get')->insertAll($var_7487);
				$var_7486=Db::table('ims_sudu8_page_score_get')->where('uniacid',$var_329)->select();
			}
			$this->assign('rules',$var_7486);
			return $this->fetch(jfrule);
		}
		else
		{
			$var_7488=Session::get('usergroup');
			if($var_7488==1)
			{
				$this->error('您没有权限操作该小程序或找不到相应小程序！','Applet/applet');
			}
			if($var_7488==2)
			{
				$this->error('您没有权限操作该小程序或找不到相应小程序！','Applet/index');
			}
			if($var_7488==3)
			{
				$this->error('您没有权限操作该小程序或找不到相应小程序！','Applet/index');
			}
		}
	}
	public function addrule()
	{
		if(powerget())
		{
			$var_7490=input('appletid');
			$var_7491=Db::name('applet')->where('id',$var_7490)->find();
			$this->assign('applet',$var_7491);
			return $this->fetch(addrule);
		}
		else
		{
			$var_7492=Session::get('usergroup');
			if($var_7492==1)
			{
				$this->error('您没有权限操作该小程序或找不到相应小程序！','Applet/applet');
			}
			if($var_7492==2)
			{
				$this->error('您没有权限操作该小程序或找不到相应小程序！','Applet/index');
			}
			if($var_7492==3)
			{
				$this->error('您没有权限操作该小程序或找不到相应小程序！','Applet/index');
			}
		}
	}
	public function saverule()
	{
		$var_7493=input('appletid');
		$var_7494['uniacid']=$var_7493;
		$var_7495=input('title');
		if($var_7495)
		{
			$var_7494['title']=$var_7495;
		}
		else
		{
			$this->error('请填写积分规则!');
		}
		$var_252=input('descp');
		if($var_252)
		{
			$var_7494['descp']=$var_252;
		}
		else
		{
			$this->error('请填写积分简介!');
		}
		$var_7496=input('score');
		if($var_7496!==null)
		{
			$var_7494['score']=$var_7496;
		}
		else
		{
			$this->error('请填写积分数!');
		}
		$var_7497=input(link);
		if($var_7497)
		{
			$var_7494[link]=$var_7497;
		}
		else
		{
			$this->error('请填写链接!');
		}
		$var_7494['flag']=input('flag');
		$var_7498=Db::table('ims_sudu8_page_score_get')->insert($var_7494);
		if($var_7498)
		{
			$this->success('积分规则添加成功!',Url('shake/jfrule').'?appletid='.$var_7493);
		}
		else
		{
			$this->error('发送未知错误,添加失败!');
		}
	}
	public function delrule()
	{
		$var_7500=input('appletid');
		$var_254=input('id');
		$var_7501=Db::table('ims_sudu8_page_score_get')->where('uniacid',$var_7500)->where('id',$var_254)->delete();
		if($var_7501)
		{
			$this->success('删除成功!');
		}
		else
		{
			$this->error('删除失败!');
		}
	}
	public function editrule()
	{
		$var_7503=input('appletid');
		$var_7504=input('id');
		$var_7505=Db::name('applet')->where('id',$var_7503)->find();
		$this->assign('applet',$var_7505);
		$var_7506=Db::table('ims_sudu8_page_score_get')->where('uniacid',$var_7503)->where('id',$var_7504)->find();
		$this->assign('rule',$var_7506);
		return $this->fetch(editrule);
	}
	public function save_editrule()
	{
		$var_2154=input('appletid');
		$var_7508=input('id');
		$var_7509=input('title');
		if($var_7509)
		{
			$var_7510['title']=$var_7509;
		}
		else
		{
			$this->error('请填写积分规则!');
		}
		$var_7511=input('descp');
		if($var_7511)
		{
			$var_7510['descp']=$var_7511;
		}
		else
		{
			$this->error('请填写积分简介!');
		}
		$var_7512=input('score');
		if($var_7512!==null)
		{
			$var_7510['score']=$var_7512;
		}
		else
		{
			$this->error('请填写积分数!');
		}
		$var_1126=input(link);
		if($var_1126)
		{
			$var_7510[link]=$var_1126;
		}
		else
		{
			$this->error('请填写链接!');
		}
		$var_7510['flag']=input('flag');
		$var_7513=Db::table('ims_sudu8_page_score_get')->where('uniacid',$var_2154)->where('id',$var_7508)->update($var_7510);
		if($var_7513!==false)
		{
			$this->success('编辑成功!',Url('shake/jfrule').'?appletid='.$var_2154);
		}
		else
		{
			$this->error('编辑失败!');
		}
	}
}
?>