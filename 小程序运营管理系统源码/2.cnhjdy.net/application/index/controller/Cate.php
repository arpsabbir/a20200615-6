<?php  namespace app\index\controller;
use think\Controller;
use think\Db;
use think\Request;
use think\Session;
use think\View;
class Cate extends Base
{
	public function index()
	{
		if(check_login())
		{
			if(powerget())
			{
				$var_5424=input('appletid');
				$var_5425=Db::table('applet')->where('id',$var_5424)->find();
				if(!$var_5425)
				{
					$this->error('找不到对应的小程序！');
				}
				$this->assign('applet',$var_5425);
				$var_5426=Db::table('ims_sudu8_page_cate')->where('uniacid',$var_5424)->where('cid',0)->order('num desc,id desc')->select();
				$var_5427=array();
				foreach($var_5426 as $var_5428=>$var_5429)
				{
					$var_5430=intval($var_5429['id']);
					if($var_5429['catepic'])
					{
						$var_5426[$var_5428]['catepic']=remote($var_5424,$var_5429['catepic'],1);
					}
					$var_5431=Db::table('ims_sudu8_page_cate')->where('uniacid',$var_5424)->where('id',$var_5430)->order('num desc,id desc')->select();
					foreach($var_5431 as $var_5432=>$var_5433)
					{
						if($var_5433['catepic'])
						{
							$var_5431[$var_5432]['catepic']=remote($var_5424,$var_5433['catepic'],1);
						}
					}
					$var_5434=Db::table('ims_sudu8_page_cate')->where('uniacid',$var_5424)->where('cid',$var_5430)->order('num desc,id desc')->select();
					foreach($var_5434 as $var_5435=>$var_809)
					{
						if($var_809['catepic'])
						{
							$var_5434[$var_5435]['catepic']=remote($var_5424,$var_809['catepic'],1);
						}
					}
					$var_5436=Db::table('ims_sudu8_page_cate')->where('uniacid',$var_5424)->where('cid',$var_5430)->order('num desc')->count();
					$var_5431['data']=$var_5434;
					$var_5431['zcount']=$var_5436;
					array_push($var_5427,$var_5431);
				}
				$this->assign('cates',$var_5427);
			}
			else
			{
				$var_5437=Session::get('usergroup');
				if($var_5437==1)
				{
					$this->error('您没有权限操作该小程序或找不到相应小程序！','Applet/applet');
				}
				if($var_5437==2)
				{
					$this->error('您没有权限操作该小程序或找不到相应小程序！','Applet/index');
				}
				if($var_5437==3)
				{
					$this->error('您没有权限操作该小程序或找不到相应小程序！','Applet/index');
				}
			}
			return $this->fetch(index);
		}
		else
		{
			$this->redirect('Login/index');
		}
	}
	public function add()
	{
		if(check_login())
		{
			if(powerget())
			{
				$var_5439=input('appletid');
				$var_5440=Db::table('applet')->where('id',$var_5439)->find();
				if(!$var_5440)
				{
					$this->error('找不到对应的小程序！');
				}
				$this->assign('applet',$var_5440);
				$var_5441=array();
				$var_5441=Db::table('ims_sudu8_page_cate')->where('uniacid',$var_5439)->select();
				$this->assign('cate',$var_5441);
				$var_5442=0;
				$var_5443=array();
				$var_5444=input('cateid');
				$var_5445=array();
				if($var_5444)
				{
					$var_5446=Db::table('ims_sudu8_page_cate')->where('id',$var_5444)->find();
					if($var_5446['catepic'])
					{
						$var_5446['catepic']=remote($var_5439,$var_5446['catepic'],1);
					}
					if($var_5446['onlyid'])
					{
						$var_5445=Db::table('products_url')->where('randid',$var_5446['onlyid'])->select();
						foreach($var_5445 as $var_18=>&$var_5447)
						{
							$var_5445[$var_18]['url']=remote($var_5439,$var_5447['url'],1);
						}
					}
					else
					{
						$var_5445=[];
					}
					if($var_5446['uniacid']==$var_5439)
					{
						$var_5443=$var_5446;
						$var_5443['cateconf']=unserialize($var_5443['cateconf']);
						if($var_5446['cid']==0)
						{
							$var_5442=1;
						}
					}
					else
					{
						$var_5448=Session::get('usergroup');
						if($var_5448==1)
						{
							$this->error('找不到该栏目，或者该栏目不属于本小程序');
						}
						if($var_5448==2)
						{
							$this->error('找不到该栏目，或者该栏目不属于本小程序');
						}
					}
				}
				else
				{
					$var_5444=0;
				}
				$this->assign('allimg',$var_5445);
				$this->assign('cateid',$var_5444);
				$this->assign('cateinfo',$var_5443);
				$this->assign('cateurlid',$var_5442);
			}
			else
			{
				$var_5448=Session::get('usergroup');
				if($var_5448==1)
				{
					$this->error('您没有权限操作该小程序或找不到相应小程序！','Applet/applet');
				}
				if($var_5448==2)
				{
					$this->error('您没有权限操作该小程序或找不到相应小程序！','Applet/index');
				}
				if($var_5448==3)
				{
					$this->error('您没有权限操作该小程序或找不到相应小程序！','Applet/index');
				}
			}
			return $this->fetch(add);
		}
		else
		{
			$this->redirect('Login/index');
		}
	}
	public function save()
	{
		$var_254=array();
		$var_254['uniacid']=input('appletid');
		$var_5449=input('num');
		if($var_5449)
		{
			$var_254['num']=$var_5449;
		}
		$var_5450=input('onlyid');
		$var_5451=input('imgsrcs/a');
		if($var_5451)
		{
			$var_5452=array();
			foreach($var_5451 as $var_739=>$var_5453)
			{
				$var_5452['randid']=$var_5450;
				$var_5452['appletid']=$var_254['uniacid'];
				$var_5452['url']=remote($var_254['uniacid'],$var_5453,2);
				$var_5452['dateline']=time();
				$var_5454=Db::table('products_url')->insert($var_5452);
			}
		}
		else
		{
			$var_5454=1;
		}
		$var_254['onlyid']=$var_5450;
		$var_5455=input('statue');
		if($var_5455===false)
		{
			$var_254['statue']=1;
		}
		else
		{
			$var_254['statue']=(int)$var_5455;
		}
		$var_5456=input('slide_is');
		if($var_5456)
		{
			$var_254['slide_is']=(int)$var_5456;
		}
		else
		{
			$var_254['slide_is']=2;
		}
		$var_2586=input('cid');
		if($var_2586)
		{
			$var_254['cid']=$var_2586;
		}
		else
		{
			$var_254['cid']=0;
		}
		$var_5457=input('name');
		if($var_5457)
		{
			$var_254['name']=$var_5457;
		}
		else
		{
			$this->error('请填写栏目名称！');
		}
		$var_5458=input('ename');
		if($var_5458)
		{
			$var_254['ename']=$var_5458;
		}
		$var_5459=Db::table('ims_sudu8_page_base')->where('uniacid',$var_254['uniacid'])->field('remote')->find()['remote'];
		$var_5460=input('commonuploadpic');
		if($var_5460)
		{
			$var_254['catepic']=remote($var_254['uniacid'],$var_5460,2);
		}
		$var_613=input('cdesc');
		if($var_613)
		{
			$var_254['cdesc']=$var_613;
		}
		$var_5461=input('pagenum');
		if($var_5461)
		{
			$var_254['pagenum']=$var_5461;
		}
		$var_5462=input('show_i');
		if($var_5462)
		{
			$var_254['show_i']=$var_5462;
		}
		else
		{
			$var_254['show_i']=0;
		}
		$var_103=input('list_tstyle');
		if($var_103)
		{
			$var_254['list_tstyle']=$var_103;
		}
		else
		{
			$var_254['list_tstyle']=0;
		}
		$var_5463=input('list_tstylel');
		if($var_5463)
		{
			$var_254['list_tstylel']=$var_5463;
		}
		else
		{
			$var_254['list_tstylel']=0;
		}
		$var_1593=input('list_style_more');
		if($var_1593)
		{
			$var_254['list_style_more']=input('list_style_more');
		}
		else
		{
			$var_254['list_style_more']=1;
		}
		$var_5464=input('list_type');
		if($var_5464)
		{
			if($var_2586==0)
			{
				$var_254['list_type']=$var_5464;
			}
			else
			{
				$var_254['list_type']=1;
			}
		}
		else
		{
			if($var_2586==0)
			{
				$var_254['list_type']=0;
			}
			else
			{
				$var_254['list_type']=1;
			}
		}
		$var_5465=input('list_stylet');
		if($var_5465)
		{
			$var_254['list_stylet']=$var_5465;
		}
		$var_5466=input('pic_page_btn');
		if($var_5466)
		{
			$var_254['pic_page_btn']=$var_5466;
		}
		else
		{
			$var_254['pic_page_btn']=0;
		}
		$var_5467=input('pic_page_btn_zt');
		if($var_5467)
		{
			$var_254['pic_page_btn_zt']=$var_5467;
		}
		else
		{
			$var_254['pic_page_btn_zt']=0;
		}
		$var_912=input('type');
		if($var_912)
		{
			$var_254['type']=$var_912;
		}
		if($var_912=='page')
		{
			$var_254['list_style']=3;
		}
		$var_5468=input('list_style');
		if($var_5468)
		{
			$var_254['list_style']=$var_5468;
		}
		else
		{
			if($var_912=='showArt'||$var_912=='showPic'||$var_912=='showWxapps')
			{
				$var_254['list_style']=1;
			}
			else if($var_912=='showPro')
			{
				$var_254['list_style']=11;
			}
		}
		$var_5469=input('pic_page_bg');
		if($var_5469!==false&& $var_5469!==null)
		{
			$var_254['pic_page_bg']=$var_5469;
		}
		else
		{
			$var_254['pic_page_bg']=0;
		}
		$v_2=input('content');
		if($v_2)
		{
			$var_254['content']=$v_2;
		}
		$var_5470=array('pmarb' =>input('pmarb'),'ptit' =>input('ptit'),);
		$var_254['cateconf']=serialize($var_5470);
		$var_30=input('cateid');
		if($var_30!=0)
		{
			$var_5471=Db::table('ims_sudu8_page_cate')->where('id',$var_30)->update($var_254);
			$var_5472=Db::table('ims_sudu8_page_products')->where('cid',$var_30)->select();
			foreach($var_5472 as $var_739=>$var_5453)
			{
				if($var_254['cid']==0)
				{
					Db::table('ims_sudu8_page_products')->where('cid',$var_30)->update(array('pcid'=>$var_30));
				}
				else
				{
					Db::table('ims_sudu8_page_products')->where('cid',$var_30)->update(array('pcid'=>$var_254['cid']));
				}
			}
		}
		else
		{
			$var_5471=Db::table('ims_sudu8_page_cate')->insert($var_254);
		}
		if($var_5471|| $var_5454)
		{
			$this->success('栏目信息更新成功！',Url('Cate/index').'?appletid='.$var_254['uniacid']);
		}
		else
		{
			$this->error('基础信息更新失败，没有修改项！');
			exit;
		}
	}
	public function del()
	{
		$var_408['id']=input('cateid');
		$var_5474=Db::table('ims_sudu8_page_cate')->where($var_408)->delete();
		if($var_5474)
		{
			$this->success('删除成功');
		}
		else
		{
			$this->success('删除失败');
		}
	}
	function onepic_uploade($v_1)
	{
		$var_5476=request()->file($v_1);
		if(isset($var_5476))
		{
			$var_5477=upload_img();
			$var_5478=$var_5476->move($var_5477);
			if($var_5478)
			{
				$var_5479=ROOT_HOST.'/upimages/'.date('Ymd',time()).'/'.$var_5478->getFilename();
				return $var_5479;
			}
		}
	}
	public function imgupload()
	{
		$var_5481['randid']=$_GET['randid'];
		$var_5482=request()->file('');
		foreach($var_5482 as $var_5483)
		{
			$var_5484=$var_5483->validate(['ext'=>'jpg,png,gif,jpeg'])->move(ROOT_PATH.'public' .DS.'upimages');
			if($var_5484)
			{
				$var_5481['url']=ROOT_HOST.'/upimages/'.date('Ymd',time()).'/'.$var_5484->getFilename();
				$var_5481['dateline']=time();
				$var_5485=Db::table('products_url')->insert($var_5481);
			}
			else
			{
				return $this->error($var_5483->getError());
			}
		}
	}
	public function getimg()
	{
		$var_5487=$_POST['id'];
		$var_5488=Db::table('products_url')->where('randid',$var_5487)->select();
		if($var_5488)
		{
			return $var_5488;
		}
	}
}
?>