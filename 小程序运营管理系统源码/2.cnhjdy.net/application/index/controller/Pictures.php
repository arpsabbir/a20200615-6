<?php  namespace app\index\controller;
use think\Controller;
use think\Db;
use think\Request;
use think\Session;
use think\View;
class Pictures extends Base
{
	public function index()
	{
		if(check_login())
		{
			if(powerget())
			{
				$var_545=input('appletid');
				$var_6875=Db::table('applet')->where('id',$var_545)->find();
				if(!$var_6875)
				{
					$this->error('找不到对应的小程序！');
				}
				$this->assign('applet',$var_6875);
				$var_6876=Db::table('ims_sudu8_page_products')->where('uniacid',$var_545)->where('type','showPic')->order('num desc')->paginate(10,false,['query' =>array('appletid'=>input('appletid'))]);
				if($var_6876->toArray())
				{
					$var_6877=$var_6876->toArray()['data'];
				}
				foreach($var_6877 as $var_6878=>&$var_6879)
				{
					if($var_6879['thumb'])
					{
						$var_6879['thumb']=remote($var_545,$var_6879['thumb'],1);
					}
					else
					{
						$var_6879['thumb']=remote($var_545,'/image/noimage.jpg',1);
					}
				}
				$var_6880=Db::table('ims_sudu8_page_products')->where('uniacid',$var_545)->where('type','showPic')->order('num desc')->count();
				$this->assign('news',$var_6876);
				$this->assign('list',$var_6877);
				$this->assign('counts',$var_6880);
			}
			else
			{
				$var_6881=Session::get('usergroup');
				if($var_6881==1)
				{
					$this->error('您没有权限操作该小程序或找不到相应小程序！','Applet/applet');
				}
				if($var_6881==2)
				{
					$this->error('您没有权限操作该小程序或找不到相应小程序！','Applet/index');
				}
				if($var_6881==3)
				{
					$this->error('您没有权限操作该小程序或找不到相应小程序！','Applet/index');
				}
			}
			return $this->fetch(index);
		}
		else
		{
			$this->redirect('Login/index');
		}
	}
	public function getcates()
	{
		$var_6882=intval(input('id'));
		$var_6883=Db::table('ims_sudu8_page_multicate')->where('id',$var_6882)->field('top_catas')->find();
		$var_6884=Db::table('ims_sudu8_page_multicates')->where('id','in',unserialize($var_6883['top_catas']))->select();
		foreach($var_6884 as $var_6885=>$var_6886)
		{
			$var_6884[$var_6885]['sons']=Db::table('ims_sudu8_page_multicates')->where('pid',$var_6886['id'])->select();
		}
		$var_6887=$var_6884;
		return json_encode($var_6887);
		exit;
	}
	public function add()
	{
		if(check_login())
		{
			if(powerget())
			{
				$var_1304=input('appletid');
				$var_962=Db::table('applet')->where('id',$var_1304)->find();
				if(!$var_962)
				{
					$this->error('找不到对应的小程序！');
				}
				$this->assign('applet',$var_962);
				$var_6889=Db::table('ims_sudu8_page_cate')->where('uniacid',$var_1304)->where('cid',0)->order('num desc')->select();
				$var_78=array();
				foreach($var_6889 as $var_6890=>$var_6891)
				{
					$var_6892=intval($var_6891['id']);
					$var_6893=Db::table('ims_sudu8_page_cate')->where('uniacid',$var_1304)->where('id',$var_6892)->order('num desc')->select();
					$var_6894=Db::table('ims_sudu8_page_cate')->where('uniacid',$var_1304)->where('cid',$var_6892)->order('num desc')->select();
					$var_6895=Db::table('ims_sudu8_page_cate')->where('uniacid',$var_1304)->where('cid',$var_6892)->order('num desc')->count();
					$var_6893['data']=$var_6894;
					$var_6893['zcount']=$var_6895;
					array_push($var_78,$var_6893);
				}
				$this->assign('cate',$var_78);
				$var_255=Db::table('ims_sudu8_page_multicate')->where('uniacid',$var_1304)->where('statue',1)->where('type','showPic')->select();
				$var_603=input('newsid');
				$var_6896=array();
				$var_6897=array();
				if($var_603)
				{
					$var_6898=Db::table('ims_sudu8_page_products')->where('id',$var_603)->where('type','showPic')->find();
					if($var_6898['uniacid']==$var_1304)
					{
						if($var_6898['thumb'])
						{
							$var_6898['thumb']=remote($var_1304,$var_6898['thumb'],1);
						}
						if($var_6898['shareimg'])
						{
							$var_6898['shareimg']=remote($var_1304,$var_6898['shareimg'],1);
						}
						if($var_6898['onlyid'])
						{
							$var_6897=Db::table('products_url')->where('randid',$var_6898['onlyid'])->select();
							foreach($var_6897 as $var_6899=>&$var_274)
							{
								$var_6897[$var_6899]['url']=remote($var_1304,$var_274['url'],1);
							}
						}
						$var_6896=$var_6898;
						$var_6900=Db::table('ims_sudu8_page_multicates')->where('id','in',$var_6896['top_catas'])->select();
						foreach($var_6900 as $var_6899=>$var_274)
						{
							$var_6900[$var_6899]['sons']=Db::table('ims_sudu8_page_multicates')->where('pid',$var_274['id'])->select();
						}
					}
					else
					{
						$var_6901=Session::get('usergroup');
						if($var_6901==1)
						{
							$this->error('找不到该内容，或者该内容不属于本小程序','Applet/applet');
						}
						if($var_6901==2)
						{
							$this->error('找不到该内容，或者该内容不属于本小程序','Applet/index');
						}
					}
				}
				else
				{
					$var_603=0;
					$var_23='';
					$var_252='';
					$var_6900='';
					foreach($var_255 as $var_6899=>$var_274)
					{
						$var_255[$var_6899]['flag']=0;
					}
				}
				$this->assign('allimg',$var_6897);
				$this->assign('sons_keys',$var_6900);
				$this->assign('imgcount',count($var_6897));
				$this->assign('newsid',$var_603);
				$this->assign('newsinfo',$var_6896);
				$this->assign('cates',$var_255);
			}
			else
			{
				$var_6901=Session::get('usergroup');
				if($var_6901==1)
				{
					$this->error('您没有权限操作该小程序或找不到相应小程序！','Applet/applet');
				}
				if($var_6901==2)
				{
					$this->error('您没有权限操作该小程序或找不到相应小程序！','Applet/index');
				}
			}
			return $this->fetch(add);
		}
		else
		{
			$this->redirect('Login/index');
		}
	}
	public function save()
	{
		$var_6903=array();
		$var_6903['uniacid']=input('appletid');
		$var_6904=input('num');
		if($var_6904)
		{
			$var_6903['num']=$var_6904;
		}
		$var_6905=input('cid');
		if($var_6905)
		{
			$var_6903['cid']=$var_6905;
			$var_6906=Db::table('ims_sudu8_page_cate')->where('id',$var_6905)->find();
			$var_6903['pcid']=$var_6906['cid'];
			$var_6903['type']=$var_6906['type'];
			$var_6903['lanmu']=$var_6906['name'];
		}
		$v_1=Db::table('ims_sudu8_page_cate')->where('id',$var_6905)->where('uniacid',input('appletid'))->field('cid')->find();
		if($v_1['cid']==0)
		{
			$var_6903['pcid']=$var_6905;
		}
		else
		{
			$var_6903['pcid']=$v_1['cid'];
		}
		$var_6907=input('type_x');
		if($var_6907)
		{
			$var_6903['type_x']=(int)$var_6907;
		}
		else
		{
			$var_6903['type_x']=0;
		}
		$var_6908=input('type_y');
		if($var_6908)
		{
			$var_6903['type_y']=(int)$var_6908;
		}
		else
		{
			$var_6903['type_y']=0;
		}
		$var_6909=input('type_i');
		if($var_6909)
		{
			$var_6903['type_i']=(int)$var_6909;
		}
		else
		{
			$var_6903['type_i']=0;
		}
		$var_6910=input('hits');
		if($var_6910)
		{
			$var_6903['hits']=$var_6910;
		}
		$var_6911=input('title');
		if($var_6911)
		{
			$var_6903['title']=$var_6911;
		}
		$var_6912=input('commonuploadpic1');
		if($var_6912)
		{
			$var_6903['thumb']=remote($var_6903['uniacid'],$var_6912,2);
		}
		$var_6913=input('commonuploadpic2');
		if($var_6913)
		{
			$var_6903['shareimg']=remote($var_6903['uniacid'],$var_6913,2);
		}
		$var_6914=input('desc');
		if($var_6914)
		{
			$var_6903['desc']=$var_6914;
		}
		$var_6915=input('onlyid');
		if($var_6915)
		{
			$var_6916=input('imgsrcs/a');
			if($var_6916)
			{
				$var_6917=array();
				foreach($var_6916 as $var_6918=>$var_6919)
				{
					$var_6917['randid']=$var_6915;
					$var_6917['appletid']=$var_6903['uniacid'];
					$var_6917['url']=remote($var_6903['uniacid'],$var_6919,2);
					$var_6917['dateline']=time();
					$var_6920=Db::table('products_url')->insert($var_6917);
				}
			}
			else
			{
				$var_6920=1;
			}
			$var_6903['onlyid']=$var_6915;
		}
		$var_6921=Db::table('products_url')->where('randid',$var_6915)->select();
		$var_6922=array();
		if($var_6921)
		{
			foreach($var_6921 as $var_68)
			{
				$var_6922[]=$var_68['url'];
			}
			$var_6903['text']=serialize($var_6922);
		}
		else
		{
			$var_6903['text']='';
		}
		$var_84=input('newsid');
		$var_6923=Db::table('ims_sudu8_page_multicate')->where('id',input('mulitcataid'))->find();
		$var_6903['sons_catas']=input('sons/a')?implode(',',input('sons/a')):'';
		$var_6903['top_catas']=$var_6923['top_catas']?implode(',',unserialize($var_6923['top_catas'])):'';
		$var_6903['mulitcataid']=input('mulitcataid');
		$var_6924=input('muiltcate');
		if($var_6924!=0)
		{
			$var_6903['multi']=1;
		}
		else
		{
			$var_6903['multi']=0;
		}
		$var_6903['get_share_gz']=input('get_share_gz');
		$var_6903['get_share_score']=input('get_share_score');
		$var_6903['get_share_num']=input('get_share_num');
		if($var_84)
		{
			$var_6903['etime']=time();
			$var_1668=Db::table('ims_sudu8_page_products')->where('id',$var_84)->update($var_6903);
		}
		else
		{
			$var_6903['ctime']=time();
			$var_1668=Db::table('ims_sudu8_page_products')->insert($var_6903);
		}
		if($var_1668)
		{
			$this->success('基础信息更新成功！',Url('Pictures/index').'?appletid='.$var_6903['uniacid']);
		}
		else
		{
			$this->error('基础信息更新失败，没有修改项！');
			exit;
		}
	}
	public function del()
	{
		$var_6926['id']=input('newsid');
		$var_6927=Db::table('ims_sudu8_page_products')->where($var_6926)->delete();
		if($var_6927)
		{
			$this->success('删除成功');
		}
		else
		{
			$this->success('删除失败');
		}
	}
	public function del_img()
	{
		$var_6929=input('id');
		$var_6930=Db::table('products_url')->where('id',$var_6929)->delete();
		if($var_6930)
		{
			return 1;
		}
		else
		{
			$this->error('删除失败！');
		}
	}
	function onepic_uploade($v_1)
	{
		$var_844=request()->file($v_1);
		if(isset($var_844))
		{
			$var_6931=upload_img();
			$var_6932=$var_844->validate(['ext'=>'jpg,png,gif,jpeg'])->move($var_6931);
			if($var_6932)
			{
				$var_2586=ROOT_HOST.'/upimages/'.date('Ymd',time()).'/'.$var_6932->getFilename();
				return $var_2586;
			}
		}
	}
	public function imgupload()
	{
		$var_6933['randid']=$_GET['randid'];
		$var_6934=request()->file('');
		foreach($var_6934 as $var_6935)
		{
			$var_6936=$var_6935->validate(['ext'=>'jpg,png,gif,jpeg'])->move(ROOT_PATH.'public' .DS.'upimages');
			if($var_6936)
			{
				$var_6933['url']=ROOT_HOST.'/upimages/'.date('Ymd',time()).'/'.$var_6936->getFilename();
				$var_6933['dateline']=time();
				$var_6937=Db::table('products_url')->insert($var_6933);
			}
			else
			{
				return $this->error($var_6935->getError());
			}
		}
	}
	public function getimg()
	{
		$var_6939=$_POST['id'];
		$var_6940=Db::table('products_url')->where('randid',$var_6939)->select();
		if($var_6940)
		{
			return $var_6940;
		}
	}
}
?>