<?php  namespace app\index\controller;
use think\Controller;
use think\Db;
use think\Request;
use think\Session;
use think\View;
class Nav extends Base
{
	public function index()
	{
		if(check_login())
		{
			if(powerget())
			{
				$var_6577=input('appletid');
				$var_6578=Db::table('applet')->where('id',$var_6577)->find();
				if(!$var_6578)
				{
					$this->error('找不到对应的小程序！');
				}
				$this->assign('applet',$var_6578);
				$var_6579=Db::table('ims_sudu8_page_nav')->where('uniacid',$var_6577)->find();
				$this->assign('bases',$var_6579);
			}
			else
			{
				$var_6580=Session::get('usergroup');
				if($var_6580==1)
				{
					$this->error('您没有权限操作该小程序或找不到相应小程序！','Applet/applet');
				}
				if($var_6580==2)
				{
					$this->error('您没有权限操作该小程序或找不到相应小程序！','Applet/index');
				}
				if($var_6580==3)
				{
					$this->error('您没有权限操作该小程序或找不到相应小程序！','Applet/index');
				}
			}
			return $this->fetch(index);
		}
		else
		{
			$this->redirect('Login/index');
		}
	}
	public function save()
	{
		$var_6582=input('appletid');
		$var_6583=array();
		$var_6583['uniacid']=input('appletid');
		$var_6584=input('url');
		if($var_6584)
		{
			$var_6583['url']=$var_6584;
		}
		$var_6585=input('statue');
		if($var_6585)
		{
			$var_6583['statue']=$var_6585;
		}
		else
		{
			$var_6583['statue']=0;
		}
		$var_6586=input('name');
		if($var_6586)
		{
			$var_6583['name']=$var_6586;
		}
		$var_6587=input('ename');
		if($var_6587)
		{
			$var_6583['ename']=$var_6587;
		}
		$var_6588=input('name_s');
		if($var_6588)
		{
			$var_6583['name_s']=$var_6588;
		}
		else
		{
			$var_6583['name_s']=0;
		}
		$var_6589=input('box_p_tb');
		if($var_6589)
		{
			$var_6583['box_p_tb']=$var_6589;
		}
		$var_18=input('box_p_lr');
		if($var_18)
		{
			$var_6583['box_p_lr']=$var_18;
		}
		$var_409=input('number');
		if($var_409)
		{
			$var_6583['number']=$var_409;
		}
		else
		{
			$var_6583['number']=5;
		}
		$var_6590=input('img_size');
		if(!empty($var_6590))
		{
			$var_6583['img_size']=$var_6590;
		}
		$var_6591=input('title_position');
		if($var_6591)
		{
			$var_6583['title_position']=$var_6591;
		}
		else
		{
			$var_6583['title_position']=0;
		}
		$var_6592=input('title_color');
		if($var_6592)
		{
			$var_6583['title_color']='#'.$var_6592;
		}
		$var_30=input('title_bg');
		if($var_30)
		{
			$var_6583['title_bg']='#'.$var_30;
		}
		$var_6593=Db::table('ims_sudu8_page_nav')->where('uniacid',$var_6582)->count();
		if($var_6593>0)
		{
			$var_6594=Db::table('ims_sudu8_page_nav')->where('uniacid',$var_6582)->update($var_6583);
		}
		else
		{
			$var_6583['uniacid']=$var_6582;
			$var_6594=Db::table('ims_sudu8_page_nav')->insert($var_6583);
		}
		if($var_6594)
		{
			$this->success('基础信息更新成功！');
		}
		else
		{
			$this->error('基础信息更新失败，没有修改项！');
			exit;
		}
	}
	function onepic_uploade($v_1)
	{
		$var_6596=request()->file($v_1);
		if(isset($var_6596))
		{
			$var_6597=upload_img();
			$var_905=$var_6596->validate(['ext'=>'jpg,png,gif,jpeg'])->move($var_6597);
			if($var_905)
			{
				$var_6598=ROOT_HOST.'/upimages/'.date('Ymd',time()).'/'.$var_905->getFilename();
				return $var_6598;
			}
		}
	}
	public function addnav()
	{
		if(check_login())
		{
			if(powerget())
			{
				$var_6599=input('appletid');
				$var_6600=Db::table('applet')->where('id',$var_6599)->find();
				if(!$var_6600)
				{
					$this->error('找不到对应的小程序！');
				}
				$this->assign('applet',$var_6600);
				$var_6601=Db::table('ims_sudu8_page_nav')->where('uniacid',$var_6599)->find();
				$var_276=input('id');
				$var_6602=array();
				if($var_276)
				{
					$var_6602=Db::table('ims_sudu8_page_navlist')->where('uniacid',$var_6599)->where('id',$var_276)->find();
					if($var_6602['pic'])
					{
						$var_6602['pic']=remote($var_6599,$var_6602['pic'],1);
					}
				}
				$this->assign('nav',$var_6602);
				$this->assign('cid',$var_276);
				$this->assign('bases',$var_6601);
			}
			else
			{
				$var_6603=Session::get('usergroup');
				if($var_6603==1)
				{
					$this->error('您没有权限操作该小程序或找不到相应小程序！','Applet/applet');
				}
				if($var_6603==2)
				{
					$this->error('您没有权限操作该小程序或找不到相应小程序！','Applet/index');
				}
				if($var_6603==3)
				{
					$this->error('您没有权限操作该小程序或找不到相应小程序！','Applet/index');
				}
			}
			return $this->fetch(addnav);
		}
		else
		{
			$this->redirect('Login/index');
		}
	}
	public function savenav()
	{
		$var_2586=array();
		$var_2586['uniacid']=input('appletid');
		$var_6604=input('num');
		if($var_6604)
		{
			$var_2586['num']=$var_6604;
		}
		$var_6605=input('flag');
		if($var_6605!==false)
		{
			$var_2586['flag']=intval($var_6605);
		}
		$var_6606=input('type');
		$var_2586['type']=$var_6606;
		$var_6607=input('title');
		if($var_6607)
		{
			$var_2586['title']=$var_6607;
		}
		$v_17=input('commonuploadpic');
		if($v_17)
		{
			$var_2586['pic']=remote($var_2586['uniacid'],$v_17,2);
		}
		$v_87=input('url');
		if($v_87)
		{
			$var_2586['url']=$v_87;
		}
		$var_240=input('url2');
		if($var_240)
		{
			$var_2586['url2']=$var_240;
		}
		$var_6608=input('id');
		if($var_6608)
		{
			$var_6609=Db::table('ims_sudu8_page_navlist')->where('id',$var_6608)->update($var_2586);
		}
		else
		{
			$var_6609=Db::table('ims_sudu8_page_navlist')->insert($var_2586);
		}
		if($var_6609)
		{
			$this->success('自定义导航更新成功！',Url('Nav/navlist').'?appletid='.$var_2586['uniacid']);
		}
		else
		{
			$this->error('自定义导航更新失败，没有修改项！');
			exit;
		}
	}
	public function navlist()
	{
		if(check_login())
		{
			if(powerget())
			{
				$var_6611=input('appletid');
				$var_6612=Db::table('applet')->where('id',$var_6611)->find();
				if(!$var_6612)
				{
					$this->error('找不到对应的小程序！');
				}
				$this->assign('applet',$var_6612);
				$var_6613=Db::table('ims_sudu8_page_nav')->where('uniacid',$var_6611)->find();
				$var_6614=Db::table('ims_sudu8_page_navlist')->where('uniacid',$var_6611)->order('num desc')->paginate(10,false,['query' =>array('appletid'=>input('appletid'))]);
				if($var_6614->toArray())
				{
					$var_6615=$var_6614->toArray()['data'];
					foreach($var_6615 as $var_6616=>&$var_6617)
					{
						if($var_6617['pic'])
						{
							$var_6617['pic']=remote($var_6611,$var_6617['pic'],1);
						}
					}
				}
				$var_6618=Db::table('ims_sudu8_page_navlist')->where('uniacid',$var_6611)->order('num desc')->count();
				$this->assign('list',$var_6615);
				$this->assign('nav',$var_6614);
				$this->assign('counts',$var_6618);
				$this->assign('bases',$var_6613);
			}
			else
			{
				$var_6619=Session::get('usergroup');
				if($var_6619==1)
				{
					$this->error('您没有权限操作该小程序或找不到相应小程序！','Applet/applet');
				}
				if($var_6619==2)
				{
					$this->error('您没有权限操作该小程序或找不到相应小程序！','Applet/index');
				}
				if($var_6619==3)
				{
					$this->error('您没有权限操作该小程序或找不到相应小程序！','Applet/index');
				}
			}
			return $this->fetch(navlist);
		}
		else
		{
			$this->redirect('Login/index');
		}
	}
	public function delete()
	{
		$var_6034=input('appletid');
		$var_6621=input('id');
		$var_6622=array('uniacid'=>$var_6034,'id'=>$var_6621);
		$var_6623=Db::table('ims_sudu8_page_navlist')->where($var_6622)->delete();
		if($var_6623)
		{
			$this->success('删除成功');
		}
		else
		{
			$this->success('删除失败');
		}
	}
}
?>